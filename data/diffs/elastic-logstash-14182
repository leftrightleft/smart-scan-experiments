diff --git a/Gemfile.template b/Gemfile.template
index 443aba33d78..b78162f960c 100644
--- a/Gemfile.template
+++ b/Gemfile.template
@@ -6,10 +6,12 @@ gem "logstash-core", :path => "./logstash-core"
 gem "logstash-core-plugin-api", :path => "./logstash-core-plugin-api"
 
 gem "paquet", "~> 0.2"
-gem "pleaserun", "~>0.0.28"
-gem "rake", "~> 12"
-gem "ruby-progressbar", "~> 1"
+gem "pleaserun", "~>0.0.28", require: false
+gem "rake", "~> 12", require: false
+gem "ruby-progressbar", "~> 1", require: false
 gem "logstash-output-elasticsearch", ">= 10.4.2"
+gem "polyglot", require: false
+gem "treetop", require: false
 gem "childprocess", "~> 4", :group => :build
 gem "fpm", "~> 1", ">= 1.14.1", :group => :build # compound due to bugfix https://github.com/jordansissel/fpm/pull/1856
 gem "gems", "~> 1", :group => :build
diff --git a/logstash-core/lib/logstash/compiler/lscl.rb b/logstash-core/lib/logstash/compiler/lscl.rb
index 9d5a6e3350b..76ddab5ed06 100644
--- a/logstash-core/lib/logstash/compiler/lscl.rb
+++ b/logstash-core/lib/logstash/compiler/lscl.rb
@@ -15,8 +15,7 @@
 # specific language governing permissions and limitations
 # under the License.
 
-require "logstash/patches/polyglot"
-require "treetop"
+require 'treetop/runtime'
 require "logstash/compiler/treetop_monkeypatches"
 require "logstash/compiler/lscl/helpers"
 require "logstash/config/string_escape"
diff --git a/logstash-core/lib/logstash/compiler/lscl/lscl_grammar.rb b/logstash-core/lib/logstash/compiler/lscl/lscl_grammar.rb
index d1a3cb9d6f8..d84f6ef0fc6 100644
--- a/logstash-core/lib/logstash/compiler/lscl/lscl_grammar.rb
+++ b/logstash-core/lib/logstash/compiler/lscl/lscl_grammar.rb
@@ -1,21 +1,7 @@
-# Licensed to Elasticsearch B.V. under one or more contributor
-# license agreements. See the NOTICE file distributed with
-# this work for additional information regarding copyright
-# ownership. Elasticsearch B.V. licenses this file to you under
-# the Apache License, Version 2.0 (the "License"); you may
-# not use this file except in compliance with the License.
-# You may obtain a copy of the License at
-#
-#  http://www.apache.org/licenses/LICENSE-2.0
-#
-# Unless required by applicable law or agreed to in writing,
-# software distributed under the License is distributed on an
-# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-# KIND, either express or implied.  See the License for the
-# specific language governing permissions and limitations
-# under the License.
-
-require "treetop"
+# Autogenerated from a Treetop grammar. Edits may be lost.
+
+
+require "treetop/runtime"
 require "logstash/compiler/lscl.rb"
 
 module LogStashCompilerLSCLGrammar
@@ -3567,3 +3553,4 @@ def _nt_selector_element
 class LogStashCompilerLSCLGrammarParser < Treetop::Runtime::CompiledParser
   include LogStashCompilerLSCLGrammar
 end
+
diff --git a/logstash-core/lib/logstash/compiler/lscl/lscl_grammar.treetop b/logstash-core/lib/logstash/compiler/lscl/lscl_grammar.treetop
index 50109cd02d8..4cb6b82f810 100644
--- a/logstash-core/lib/logstash/compiler/lscl/lscl_grammar.treetop
+++ b/logstash-core/lib/logstash/compiler/lscl/lscl_grammar.treetop
@@ -1,4 +1,4 @@
-require "treetop"
+require "treetop/runtime"
 require "logstash/compiler/lscl.rb"
 
 grammar LogStashCompilerLSCLGrammar
diff --git a/logstash-core/lib/logstash/compiler/treetop_monkeypatches.rb b/logstash-core/lib/logstash/compiler/treetop_monkeypatches.rb
index 6ad1823b3ce..cbc02128a34 100644
--- a/logstash-core/lib/logstash/compiler/treetop_monkeypatches.rb
+++ b/logstash-core/lib/logstash/compiler/treetop_monkeypatches.rb
@@ -15,6 +15,8 @@
 # specific language governing permissions and limitations
 # under the License.
 
+require 'treetop/runtime'
+
 class Treetop::Runtime::SyntaxNode
   def get_meta(key)
     @ast_metadata ||= {}
diff --git a/logstash-core/lib/logstash/config/config_ast.rb b/logstash-core/lib/logstash/config/config_ast.rb
index c7c5f9cfee0..8d57b644198 100644
--- a/logstash-core/lib/logstash/config/config_ast.rb
+++ b/logstash-core/lib/logstash/config/config_ast.rb
@@ -16,7 +16,7 @@
 # under the License.
 
 require "logstash/compiler/lscl/helpers"
-require "treetop"
+require 'treetop/runtime'
 
 require "logstash/compiler/treetop_monkeypatches"
 
diff --git a/logstash-core/lib/logstash/config/grammar.rb b/logstash-core/lib/logstash/config/grammar.rb
index 7007fee7490..5cb3dc683a0 100644
--- a/logstash-core/lib/logstash/config/grammar.rb
+++ b/logstash-core/lib/logstash/config/grammar.rb
@@ -15,7 +15,7 @@
 # specific language governing permissions and limitations
 # under the License.
 
-require "treetop"
+require "treetop/runtime"
 require "logstash/config/config_ast"
 
 module LogStashConfig
diff --git a/logstash-core/lib/logstash/config/grammar.treetop b/logstash-core/lib/logstash/config/grammar.treetop
index 710684dee28..aaa7d223cbd 100644
--- a/logstash-core/lib/logstash/config/grammar.treetop
+++ b/logstash-core/lib/logstash/config/grammar.treetop
@@ -1,4 +1,4 @@
-require "treetop"
+require "treetop/runtime"
 require "logstash/config/config_ast"
 
 grammar LogStashConfig
diff --git a/logstash-core/lib/logstash/patches/polyglot.rb b/logstash-core/lib/logstash/patches/polyglot.rb
index 1e9c14bd03a..7e319d4c38d 100644
--- a/logstash-core/lib/logstash/patches/polyglot.rb
+++ b/logstash-core/lib/logstash/patches/polyglot.rb
@@ -1,6 +1,7 @@
+# NOTE: this patch is meant to be used when polyglot (a tree-top dependency) is loaded.
+# At runtime we avoid loading polyglot, it's only needed for the rake compile task atm.
 require 'polyglot'
 
-
 module Kernel
   alias original_require require
 
diff --git a/logstash-core/spec/logstash/webserver_spec.rb b/logstash-core/spec/logstash/webserver_spec.rb
index 6e2d0105af4..5f869bde7dc 100644
--- a/logstash-core/spec/logstash/webserver_spec.rb
+++ b/logstash-core/spec/logstash/webserver_spec.rb
@@ -183,7 +183,7 @@ def free_ports(servers)
     context "and invalid basic auth is provided" do
       it 'emits an HTTP 401 with WWW-Authenticate header' do
         response = Faraday.new("http://#{api_host}:#{webserver.port}") do |conn|
-          conn.request :basic_auth, 'john-doe', 'open-sesame'
+          conn.request :authorization, :basic, 'john-doe', 'open-sesame'
         end.get('/')
         aggregate_failures do
           expect(response.status).to eq(401)
@@ -194,7 +194,7 @@ def free_ports(servers)
     context "and valid auth is provided" do
       it "returns a relevant response" do
         response = Faraday.new("http://#{api_host}:#{webserver.port}") do |conn|
-          conn.request :basic_auth, 'a-user', 's3cur3dPas!'
+          conn.request :authorization, :basic, 'a-user', 's3cur3dPas!'
         end.get('/')
         aggregate_failures do
           expect(response.status).to eq(200)
diff --git a/x-pack/qa/integration/spec_helper.rb b/x-pack/qa/integration/spec_helper.rb
index 38fb1a22456..974092b02af 100644
--- a/x-pack/qa/integration/spec_helper.rb
+++ b/x-pack/qa/integration/spec_helper.rb
@@ -7,6 +7,5 @@
 require_relative "support/helpers"
 require_relative "support/shared_examples"
 require_relative "support/elasticsearch/api/actions/update_password"
-require "logstash/patches/polyglot"
 require "json"
 require "json-schema"
