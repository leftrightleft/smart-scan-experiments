diff --git a/CHANGELOG b/CHANGELOG
index e6b2b647cab..7aba7ea0309 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -1,3 +1,41 @@
+1.5.0-rc3
+  # general
+  - Added back the ability to install plugin gems built locally on top of Logstash. This will 
+    help plugin developers iterate and test locally without having to publish plugins (#2779)
+  - Fixed performance regressions from 1.4.2 especially for configurations which have 
+    conditionals in filter and output. Throughput numbers are either inline with 1.4.2
+    or improved for certain configurations (#2870)
+  - Fixed issue in core which was causing Logstash to not shutdown properly (#2796)    
+  - Added ability to add extra JVM options while running LS. You can use the LS_JAVA_OPTS 
+    environment variable to add to the default JVM options set out of the box. You could also
+    completely overwrite all the default options if you wish by setting JAVA_OPTS before
+    starting Logstash (#2942)
+  - Fixed a regression from 1.4.2 where removing a tag in filter fails if the input event is
+    JSON formatted (#2261)
+  - Fixed issue where setting workers > 1 would trigger messages like
+    "You are using a deprecated config setting ..." (#2865)
+  - Deprecated elasticsearch_http output plugin: All functionality is ported to
+    logstash-output-elasticsearch plugin using http protocol (#1757). If you try to use
+    the elasticsearch_http plugin, it will log a deprecated notice now.
+
+  # input
+  - File: When shutting down Logstash with file input, it would log a "permissions denied"
+    message. We fixed the underlying sinceDB issue while writing to a directory with no
+    permissions (#2964, #2935, #2882, file-input#16)
+
+  # filter
+  - Multiline: Fixed an issue where Logstash would crash while processing JSON formatted
+    events on Java 8 (#10)
+  - Mutate: Fixed issue where you can safely delete/rename fields which can have nil
+    values (#2977)
+
+  # output
+  - Deprecate the usage of index_type configuration. Added document_type to be consistent
+    with document_id (#102)
+  - Added warning when used with config embedded => true. Starting an embedded Elasticsearch
+    node is only recommended while prototyping. This should never be used in 
+    production setting (#99)
+
 1.5.0.rc2
   # general
   - Fixed an issue with packaging our release artifacts. Release artifacts were missing jar files
diff --git a/Gemfile.defaults b/Gemfile.defaults
new file mode 100644
index 00000000000..16ad4bf3c26
--- /dev/null
+++ b/Gemfile.defaults
@@ -0,0 +1,107 @@
+# This is a Logstash generated Gemfile.
+# If you modify this file manually all comments and formatting will be lost.
+
+source "https://rubygems.org"
+gem "logstash-core"
+gem "logstash-input-heartbeat"
+gem "logstash-output-zeromq"
+gem "logstash-codec-collectd"
+gem "logstash-output-xmpp"
+gem "logstash-codec-dots"
+gem "logstash-codec-edn"
+gem "logstash-codec-edn_lines"
+gem "logstash-codec-fluent"
+gem "logstash-codec-es_bulk"
+gem "logstash-codec-graphite"
+gem "logstash-codec-json"
+gem "logstash-codec-json_lines"
+gem "logstash-codec-line"
+gem "logstash-codec-msgpack"
+gem "logstash-codec-multiline"
+gem "logstash-codec-netflow"
+gem "logstash-codec-oldlogstashjson"
+gem "logstash-codec-plain"
+gem "logstash-codec-rubydebug"
+gem "logstash-filter-anonymize"
+gem "logstash-filter-checksum"
+gem "logstash-filter-clone"
+gem "logstash-filter-csv"
+gem "logstash-filter-date"
+gem "logstash-filter-dns"
+gem "logstash-filter-drop"
+gem "logstash-filter-fingerprint"
+gem "logstash-filter-geoip"
+gem "logstash-filter-grok"
+gem "logstash-filter-json"
+gem "logstash-filter-kv"
+gem "logstash-filter-metrics"
+gem "logstash-filter-multiline"
+gem "logstash-filter-mutate"
+gem "logstash-filter-ruby"
+gem "logstash-filter-sleep"
+gem "logstash-filter-split"
+gem "logstash-filter-syslog_pri"
+gem "logstash-filter-throttle"
+gem "logstash-filter-urldecode"
+gem "logstash-filter-useragent"
+gem "logstash-filter-uuid"
+gem "logstash-filter-xml"
+gem "logstash-input-couchdb_changes"
+gem "logstash-input-elasticsearch"
+gem "logstash-input-eventlog"
+gem "logstash-input-exec"
+gem "logstash-input-file"
+gem "logstash-input-ganglia"
+gem "logstash-input-gelf"
+gem "logstash-input-generator"
+gem "logstash-input-graphite"
+gem "logstash-input-imap"
+gem "logstash-input-irc"
+gem "logstash-input-kafka"
+gem "logstash-input-log4j"
+gem "logstash-input-lumberjack"
+gem "logstash-input-pipe"
+gem "logstash-input-rabbitmq"
+gem "logstash-input-redis"
+gem "logstash-input-s3"
+gem "logstash-input-snmptrap"
+gem "logstash-input-sqs"
+gem "logstash-input-stdin"
+gem "logstash-input-syslog"
+gem "logstash-input-tcp"
+gem "logstash-input-twitter"
+gem "logstash-input-udp"
+gem "logstash-input-unix"
+gem "logstash-input-xmpp"
+gem "logstash-input-zeromq"
+gem "logstash-output-cloudwatch"
+gem "logstash-output-csv"
+gem "logstash-output-elasticsearch"
+gem "logstash-output-elasticsearch_http"
+gem "logstash-output-email"
+gem "logstash-output-exec"
+gem "logstash-output-file"
+gem "logstash-output-ganglia"
+gem "logstash-output-gelf"
+gem "logstash-output-graphite"
+gem "logstash-output-hipchat"
+gem "logstash-output-http"
+gem "logstash-output-irc"
+gem "logstash-output-juggernaut"
+gem "logstash-output-kafka"
+gem "logstash-output-lumberjack"
+gem "logstash-output-nagios"
+gem "logstash-output-nagios_nsca"
+gem "logstash-output-null"
+gem "logstash-output-opentsdb"
+gem "logstash-output-pagerduty"
+gem "logstash-output-pipe"
+gem "logstash-output-rabbitmq"
+gem "logstash-output-redis"
+gem "logstash-output-s3"
+gem "logstash-output-sns"
+gem "logstash-output-sqs"
+gem "logstash-output-statsd"
+gem "logstash-output-stdout"
+gem "logstash-output-tcp"
+gem "logstash-output-udp"
diff --git a/Gemfile.jruby-1.9.lock b/Gemfile.jruby-1.9.lock
index 2769b32dbf2..ce67e9b9460 100644
--- a/Gemfile.jruby-1.9.lock
+++ b/Gemfile.jruby-1.9.lock
@@ -1,21 +1,18 @@
 PATH
   remote: .
   specs:
-    logstash (2.0.0.dev-java)
+    logstash-core (1.5.0.rc3.snapshot6-java)
       cabin (>= 0.7.0)
       clamp
       file-dependencies (= 0.1.6)
       filesize
       ftw (~> 0.0.40)
       i18n (= 0.6.9)
-      jar-dependencies (= 0.1.7)
       jrjackson
-      maven-tools (= 1.0.7)
       mime-types
       minitar
       pry
       rack
-      ruby-maven (= 3.1.1.0.8)
       sinatra
       stud
       treetop (~> 1.4.0)
@@ -23,32 +20,25 @@ PATH
 GEM
   remote: https://rubygems.org/
   specs:
-    addressable (2.3.7)
-    axiom-types (0.1.1)
-      descendants_tracker (~> 0.0.4)
-      ice_nine (~> 0.11.0)
-      thread_safe (~> 0.3, >= 0.3.1)
+    addressable (2.3.8)
     backports (3.6.4)
     builder (3.2.2)
     cabin (0.7.1)
     ci_reporter (1.9.3)
       builder (>= 2.1.2)
-    clamp (0.6.3)
+    clamp (0.6.4)
     coderay (1.1.0)
-    coercible (1.0.0)
-      descendants_tracker (~> 0.0.1)
-    coveralls (0.7.10)
-      multi_json (~> 1.10)
+    coveralls (0.8.1)
+      json (~> 1.8)
       rest-client (>= 1.6.8, < 2)
-      simplecov (~> 0.9.1)
+      simplecov (~> 0.10.0)
       term-ansicolor (~> 1.3)
       thor (~> 0.19.1)
-    descendants_tracker (0.0.4)
-      thread_safe (~> 0.3, >= 0.3.1)
     diff-lcs (1.2.5)
     docile (1.1.5)
-    equalizer (0.0.9)
-    ffi (1.9.6-java)
+    domain_name (0.5.24)
+      unf (>= 0.0.5, < 1.0.0)
+    ffi (1.9.8-java)
     file-dependencies (0.1.6)
       minitar
     filesize (0.0.4)
@@ -58,12 +48,14 @@ GEM
       cabin (> 0)
       http_parser.rb (~> 0.6)
     gem_publisher (1.5.0)
+    http-cookie (1.0.2)
+      domain_name (~> 0.5)
     http_parser.rb (0.6.0-java)
     i18n (0.6.9)
-    ice_nine (0.11.1)
     insist (1.0.0)
     jar-dependencies (0.1.7)
     jrjackson (0.2.8)
+    json (1.8.2-java)
     logstash-devutils (0.0.12-java)
       gem_publisher
       insist (= 1.0.0)
@@ -71,13 +63,10 @@ GEM
       minitar
       rake
       rspec (~> 2.14.0)
-    maven-tools (1.0.7)
-      virtus (~> 1.0)
     method_source (0.8.2)
     mime-types (2.4.3)
     minitar (0.5.4)
-    multi_json (1.10.1)
-    netrc (0.10.2)
+    netrc (0.10.3)
     polyglot (0.3.5)
     pry (0.10.1-java)
       coderay (~> 1.1.0)
@@ -88,7 +77,8 @@ GEM
     rack-protection (1.5.3)
       rack
     rake (10.4.2)
-    rest-client (1.7.3)
+    rest-client (1.8.0)
+      http-cookie (>= 1.0.2, < 2.0)
       mime-types (>= 1.16, < 3.0)
       netrc (~> 0.7)
     rspec (2.14.1)
@@ -99,19 +89,15 @@ GEM
     rspec-expectations (2.14.5)
       diff-lcs (>= 1.1.3, < 2.0)
     rspec-mocks (2.14.6)
-    ruby-maven (3.1.1.0.8)
-      maven-tools (~> 1.0.1)
-      ruby-maven-libs (= 3.1.1)
-    ruby-maven-libs (3.1.1)
-    simplecov (0.9.2)
+    simplecov (0.10.0)
       docile (~> 1.1.0)
-      multi_json (~> 1.0)
-      simplecov-html (~> 0.9.0)
-    simplecov-html (0.9.0)
-    sinatra (1.4.5)
+      json (~> 1.8)
+      simplecov-html (~> 0.10.0)
+    simplecov-html (0.10.0)
+    sinatra (1.4.6)
       rack (~> 1.4)
       rack-protection (~> 1.4)
-      tilt (~> 1.3, >= 1.3.4)
+      tilt (>= 1.3, < 3)
     slop (3.6.0)
     spoon (0.0.4)
       ffi
@@ -119,17 +105,12 @@ GEM
     term-ansicolor (1.3.0)
       tins (~> 1.0)
     thor (0.19.1)
-    thread_safe (0.3.4-java)
-    tilt (1.4.1)
-    tins (1.3.4)
+    tilt (2.0.1)
+    tins (1.3.5)
     treetop (1.4.15)
       polyglot
       polyglot (>= 0.3.1)
-    virtus (1.0.4)
-      axiom-types (~> 0.1)
-      coercible (~> 1.0)
-      descendants_tracker (~> 0.0, >= 0.0.3)
-      equalizer (~> 0.0, >= 0.0.9)
+    unf (0.1.4-java)
 
 PLATFORMS
   java
@@ -137,7 +118,7 @@ PLATFORMS
 DEPENDENCIES
   ci_reporter (= 1.9.3)
   coveralls
-  logstash!
+  logstash-core!
   logstash-devutils
   rspec (~> 2.14.0)
   simplecov
diff --git a/Gemfile.jruby-1.9.lock.defaults b/Gemfile.jruby-1.9.lock.defaults
new file mode 100644
index 00000000000..69703ea8db4
--- /dev/null
+++ b/Gemfile.jruby-1.9.lock.defaults
@@ -0,0 +1,623 @@
+GEM
+  remote: https://rubygems.org/
+  specs:
+    addressable (2.3.8)
+    atomic (1.1.99-java)
+    avl_tree (1.2.1)
+      atomic (~> 1.1)
+    awesome_print (1.6.1)
+    aws-sdk (1.61.0)
+      aws-sdk-v1 (= 1.61.0)
+    aws-sdk-v1 (1.61.0)
+      json (~> 1.4)
+      nokogiri (>= 1.4.4)
+    axiom-types (0.1.1)
+      descendants_tracker (~> 0.0.4)
+      ice_nine (~> 0.11.0)
+      thread_safe (~> 0.3, >= 0.3.1)
+    backports (3.6.4)
+    bindata (2.1.0)
+    buftok (0.2.0)
+    cabin (0.7.1)
+    cinch (2.2.5)
+    clamp (0.6.4)
+    coderay (1.1.0)
+    coercible (1.0.0)
+      descendants_tracker (~> 0.0.1)
+    concurrent-ruby (0.8.0-java)
+    descendants_tracker (0.0.4)
+      thread_safe (~> 0.3, >= 0.3.1)
+    edn (1.0.6)
+    elasticsearch (1.0.8)
+      elasticsearch-api (= 1.0.7)
+      elasticsearch-transport (= 1.0.7)
+    elasticsearch-api (1.0.7)
+      multi_json
+    elasticsearch-transport (1.0.7)
+      faraday
+      multi_json
+    equalizer (0.0.11)
+    faraday (0.9.1)
+      multipart-post (>= 1.2, < 3)
+    ffi (1.9.8-java)
+    ffi-rzmq (2.0.4)
+      ffi-rzmq-core (>= 1.0.1)
+    ffi-rzmq-core (1.0.3)
+      ffi (~> 1.9)
+    file-dependencies (0.1.6)
+      minitar
+    filesize (0.0.4)
+    filewatch (0.6.2)
+    ftw (0.0.42)
+      addressable
+      backports (>= 2.6.2)
+      cabin (> 0)
+      http_parser.rb (~> 0.6)
+    gelf (1.3.2)
+      json
+    gelfd (0.2.0)
+    geoip (1.5.0)
+    gmetric (0.1.3)
+    hitimes (1.2.2-java)
+    http (0.6.4)
+      http_parser.rb (~> 0.6.0)
+    http_parser.rb (0.6.0-java)
+    i18n (0.6.9)
+    ice_nine (0.11.1)
+    jar-dependencies (0.1.7)
+    jls-grok (0.11.2)
+      cabin (>= 0.6.0)
+    jls-lumberjack (0.0.22)
+    jrjackson (0.2.8)
+    jruby-kafka (1.4.0-java)
+      jar-dependencies (~> 0)
+      ruby-maven (~> 3.1)
+    jruby-win32ole (0.8.5)
+    json (1.8.2-java)
+    logstash-codec-collectd (0.1.9)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-dots (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-edn (0.1.6)
+      edn
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-edn_lines (0.1.7)
+      edn
+      logstash-codec-line
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-es_bulk (0.1.6)
+      logstash-codec-line
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-fluent (0.1.6-java)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      msgpack-jruby
+    logstash-codec-graphite (0.1.6)
+      logstash-codec-line
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-json (0.1.7)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-json_lines (0.1.7)
+      logstash-codec-line
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-line (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-msgpack (0.1.7-java)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      msgpack-jruby
+    logstash-codec-multiline (0.1.9)
+      jls-grok (~> 0.11.1)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-patterns-core
+    logstash-codec-netflow (0.1.5)
+      bindata (>= 1.5.0)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-oldlogstashjson (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-plain (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-codec-rubydebug (0.1.7)
+      awesome_print
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-core (1.5.0.rc3.snapshot6-java)
+      cabin (>= 0.7.0)
+      clamp
+      file-dependencies (= 0.1.6)
+      filesize
+      ftw (~> 0.0.40)
+      i18n (= 0.6.9)
+      jrjackson
+      mime-types
+      minitar
+      pry
+      rack
+      sinatra
+      stud
+      treetop (~> 1.4.0)
+    logstash-filter-anonymize (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      murmurhash3
+    logstash-filter-checksum (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-clone (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-csv (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-date (0.1.6)
+      logstash-codec-json
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-input-generator
+      logstash-output-null
+    logstash-filter-dns (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-drop (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-fingerprint (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      murmurhash3
+    logstash-filter-geoip (0.1.9)
+      geoip (>= 1.3.2)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-grok (0.1.9)
+      jls-grok (~> 0.11.1)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-patterns-core
+    logstash-filter-json (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-kv (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-metrics (0.1.8)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      metriks
+      thread_safe
+    logstash-filter-multiline (0.1.6)
+      jls-grok (~> 0.11.0)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-filter-mutate
+      logstash-patterns-core
+    logstash-filter-mutate (0.1.7)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-filter-grok
+      logstash-patterns-core
+    logstash-filter-ruby (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-filter-date
+    logstash-filter-sleep (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-split (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-syslog_pri (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-throttle (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-urldecode (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-useragent (0.1.8)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      user_agent_parser (>= 2.0.0)
+    logstash-filter-uuid (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-filter-xml (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      nokogiri
+      xml-simple
+    logstash-input-couchdb_changes (0.1.5)
+      json
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-elasticsearch (0.1.5)
+      elasticsearch (~> 1.0, >= 1.0.6)
+      logstash-codec-json
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-eventlog (0.1.5-java)
+      jruby-win32ole
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-exec (0.1.4)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-file (0.1.9)
+      addressable
+      filewatch (~> 0.6, >= 0.6.2)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-ganglia (0.1.4)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-gelf (0.1.5)
+      gelf (= 1.3.2)
+      gelfd (= 0.2.0)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-generator (0.1.5)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-graphite (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-input-tcp
+    logstash-input-heartbeat (0.1.6)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+      stud
+    logstash-input-imap (0.1.4)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+      mail
+      stud
+    logstash-input-irc (0.1.4)
+      cinch
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-kafka (0.1.13)
+      jar-dependencies (= 0.1.7)
+      jruby-kafka (>= 1.2.0, < 2.0.0)
+      logstash-codec-json
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+      maven-tools (= 1.0.7)
+      ruby-maven (= 3.1.1.0.8)
+    logstash-input-log4j (0.1.7-java)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-lumberjack (0.1.5)
+      jls-lumberjack (>= 0.0.20)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-pipe (0.1.6)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-rabbitmq (0.1.4-java)
+      logstash-codec-json
+      logstash-core (>= 1.4.0, < 2.0.0)
+      march_hare (~> 2.5.1)
+    logstash-input-redis (0.1.5)
+      logstash-codec-json
+      logstash-core (>= 1.4.0, < 2.0.0)
+      redis
+    logstash-input-s3 (0.1.9)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-mixin-aws
+      stud (~> 0.0.18)
+    logstash-input-snmptrap (0.1.5)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      snmp
+    logstash-input-sqs (0.1.4)
+      aws-sdk
+      logstash-codec-json
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-stdin (0.1.4)
+      logstash-codec-json
+      logstash-codec-json_lines
+      logstash-codec-line
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-syslog (0.1.5)
+      concurrent-ruby
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-filter-date
+      logstash-filter-grok
+      thread_safe
+    logstash-input-tcp (0.1.5)
+      logstash-codec-json
+      logstash-codec-json_lines
+      logstash-codec-line
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-twitter (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      twitter (= 5.12.0)
+    logstash-input-udp (0.1.4)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-unix (0.1.4)
+      logstash-codec-line
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-input-xmpp (0.1.4)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+      xmpp4r (= 0.5)
+    logstash-input-zeromq (0.1.5)
+      ffi-rzmq (~> 2.0.4)
+      logstash-codec-json
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-mixin-aws (0.1.9)
+      aws-sdk (~> 1.61.0)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-cloudwatch (0.1.4)
+      aws-sdk
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-mixin-aws
+      rufus-scheduler (~> 2.0.24)
+    logstash-output-csv (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-filter-json
+      logstash-output-file
+    logstash-output-elasticsearch (0.2.4-java)
+      cabin (~> 0.6)
+      concurrent-ruby
+      elasticsearch (~> 1.0, >= 1.0.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      manticore (~> 0.3)
+      stud (~> 0.0, >= 0.0.17)
+    logstash-output-elasticsearch_http (0.0.2)
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-output-elasticsearch
+    logstash-output-email (0.1.8)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      mail (~> 2.6.0, >= 2.6.3)
+    logstash-output-exec (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-file (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-input-generator
+    logstash-output-ganglia (0.1.4)
+      gmetric (= 0.1.3)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-gelf (0.1.4)
+      gelf (= 1.3.2)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-graphite (0.1.8)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-hipchat (0.1.4)
+      ftw (~> 0.0.40)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-http (0.1.4)
+      ftw (~> 0.0.40)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-irc (0.1.4)
+      cinch
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-juggernaut (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      redis
+    logstash-output-kafka (0.1.9)
+      jar-dependencies (= 0.1.7)
+      jruby-kafka (>= 1.1.0, < 2.0.0)
+      logstash-codec-json
+      logstash-codec-plain
+      logstash-core (>= 1.4.0, < 2.0.0)
+      maven-tools (= 1.0.7)
+      ruby-maven (= 3.1.1.0.8)
+    logstash-output-lumberjack (0.1.5)
+      jls-lumberjack (>= 0.0.20)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-nagios (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-nagios_nsca (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-null (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-opentsdb (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-pagerduty (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-pipe (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-rabbitmq (0.1.5-java)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      march_hare (~> 2.5.1)
+    logstash-output-redis (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      redis
+      stud
+    logstash-output-s3 (0.1.7)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-mixin-aws
+      stud (~> 0.0.18)
+    logstash-output-sns (0.1.4)
+      aws-sdk
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-mixin-aws
+    logstash-output-sqs (0.1.4)
+      aws-sdk
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-mixin-aws
+      stud
+    logstash-output-statsd (0.1.6)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      logstash-input-generator
+      statsd-ruby (= 1.2.0)
+    logstash-output-stdout (0.1.5)
+      logstash-codec-line
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-tcp (0.1.5)
+      logstash-codec-json
+      logstash-core (>= 1.4.0, < 2.0.0)
+      stud
+    logstash-output-udp (0.1.5)
+      logstash-codec-json
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-output-xmpp (0.1.4)
+      logstash-core (>= 1.4.0, < 2.0.0)
+      xmpp4r (= 0.5)
+    logstash-output-zeromq (0.1.6)
+      ffi-rzmq (~> 2.0.4)
+      logstash-codec-json
+      logstash-core (>= 1.4.0, < 2.0.0)
+    logstash-patterns-core (0.1.7)
+      logstash-core (>= 1.4.0, < 2.0.0)
+    mail (2.6.3)
+      mime-types (>= 1.16, < 3)
+    manticore (0.4.1-java)
+      addressable (~> 2.3)
+    march_hare (2.5.1-java)
+    maven-tools (1.0.7)
+      virtus (~> 1.0)
+    memoizable (0.4.2)
+      thread_safe (~> 0.3, >= 0.3.1)
+    method_source (0.8.2)
+    metriks (0.9.9.7)
+      atomic (~> 1.0)
+      avl_tree (~> 1.2.0)
+      hitimes (~> 1.1)
+    mime-types (2.4.3)
+    minitar (0.5.4)
+    msgpack-jruby (1.4.1-java)
+    multi_json (1.11.0)
+    multipart-post (2.0.0)
+    murmurhash3 (0.1.6-java)
+    naught (1.0.0)
+    nokogiri (1.6.6.2-java)
+    polyglot (0.3.5)
+    pry (0.10.1-java)
+      coderay (~> 1.1.0)
+      method_source (~> 0.8.1)
+      slop (~> 3.4)
+      spoon (~> 0.0)
+    rack (1.6.0)
+    rack-protection (1.5.3)
+      rack
+    redis (3.2.1)
+    ruby-maven (3.1.1.0.8)
+      maven-tools (~> 1.0.1)
+      ruby-maven-libs (= 3.1.1)
+    ruby-maven-libs (3.1.1)
+    rufus-scheduler (2.0.24)
+      tzinfo (>= 0.3.22)
+    simple_oauth (0.3.1)
+    sinatra (1.4.6)
+      rack (~> 1.4)
+      rack-protection (~> 1.4)
+      tilt (>= 1.3, < 3)
+    slop (3.6.0)
+    snmp (1.2.0)
+    spoon (0.0.4)
+      ffi
+    statsd-ruby (1.2.0)
+    stud (0.0.19)
+    thread_safe (0.3.5-java)
+    tilt (2.0.1)
+    treetop (1.4.15)
+      polyglot
+      polyglot (>= 0.3.1)
+    twitter (5.12.0)
+      addressable (~> 2.3)
+      buftok (~> 0.2.0)
+      equalizer (~> 0.0.9)
+      faraday (~> 0.9.0)
+      http (~> 0.6.0)
+      http_parser.rb (~> 0.6.0)
+      json (~> 1.8)
+      memoizable (~> 0.4.0)
+      naught (~> 1.0)
+      simple_oauth (~> 0.3.0)
+    tzinfo (1.2.2)
+      thread_safe (~> 0.1)
+    user_agent_parser (2.2.0)
+    virtus (1.0.5)
+      axiom-types (~> 0.1)
+      coercible (~> 1.0)
+      descendants_tracker (~> 0.0, >= 0.0.3)
+      equalizer (~> 0.0, >= 0.0.9)
+    xml-simple (1.1.5)
+    xmpp4r (0.5)
+
+PLATFORMS
+  java
+
+DEPENDENCIES
+  logstash-codec-collectd
+  logstash-codec-dots
+  logstash-codec-edn
+  logstash-codec-edn_lines
+  logstash-codec-es_bulk
+  logstash-codec-fluent
+  logstash-codec-graphite
+  logstash-codec-json
+  logstash-codec-json_lines
+  logstash-codec-line
+  logstash-codec-msgpack
+  logstash-codec-multiline
+  logstash-codec-netflow
+  logstash-codec-oldlogstashjson
+  logstash-codec-plain
+  logstash-codec-rubydebug
+  logstash-core
+  logstash-filter-anonymize
+  logstash-filter-checksum
+  logstash-filter-clone
+  logstash-filter-csv
+  logstash-filter-date
+  logstash-filter-dns
+  logstash-filter-drop
+  logstash-filter-fingerprint
+  logstash-filter-geoip
+  logstash-filter-grok
+  logstash-filter-json
+  logstash-filter-kv
+  logstash-filter-metrics
+  logstash-filter-multiline
+  logstash-filter-mutate
+  logstash-filter-ruby
+  logstash-filter-sleep
+  logstash-filter-split
+  logstash-filter-syslog_pri
+  logstash-filter-throttle
+  logstash-filter-urldecode
+  logstash-filter-useragent
+  logstash-filter-uuid
+  logstash-filter-xml
+  logstash-input-couchdb_changes
+  logstash-input-elasticsearch
+  logstash-input-eventlog
+  logstash-input-exec
+  logstash-input-file
+  logstash-input-ganglia
+  logstash-input-gelf
+  logstash-input-generator
+  logstash-input-graphite
+  logstash-input-heartbeat
+  logstash-input-imap
+  logstash-input-irc
+  logstash-input-kafka
+  logstash-input-log4j
+  logstash-input-lumberjack
+  logstash-input-pipe
+  logstash-input-rabbitmq
+  logstash-input-redis
+  logstash-input-s3
+  logstash-input-snmptrap
+  logstash-input-sqs
+  logstash-input-stdin
+  logstash-input-syslog
+  logstash-input-tcp
+  logstash-input-twitter
+  logstash-input-udp
+  logstash-input-unix
+  logstash-input-xmpp
+  logstash-input-zeromq
+  logstash-output-cloudwatch
+  logstash-output-csv
+  logstash-output-elasticsearch
+  logstash-output-elasticsearch_http
+  logstash-output-email
+  logstash-output-exec
+  logstash-output-file
+  logstash-output-ganglia
+  logstash-output-gelf
+  logstash-output-graphite
+  logstash-output-hipchat
+  logstash-output-http
+  logstash-output-irc
+  logstash-output-juggernaut
+  logstash-output-kafka
+  logstash-output-lumberjack
+  logstash-output-nagios
+  logstash-output-nagios_nsca
+  logstash-output-null
+  logstash-output-opentsdb
+  logstash-output-pagerduty
+  logstash-output-pipe
+  logstash-output-rabbitmq
+  logstash-output-redis
+  logstash-output-s3
+  logstash-output-sns
+  logstash-output-sqs
+  logstash-output-statsd
+  logstash-output-stdout
+  logstash-output-tcp
+  logstash-output-udp
+  logstash-output-xmpp
+  logstash-output-zeromq
diff --git a/README.md b/README.md
index 13a6ce49781..40f46f3785f 100644
--- a/README.md
+++ b/README.md
@@ -99,7 +99,7 @@ we provide from the Logstash site!
 
 **Note** Before you build the artifacts, you need to run:
 
-    rake artifact:freeze-defaults-gemfile 
+    rake artifact:freeze-defaults-gemfile
 
 If you want to build the release tarball yourself, run:
 
diff --git a/bin/bundle b/bin/bundle
new file mode 100755
index 00000000000..aaae921c4c5
--- /dev/null
+++ b/bin/bundle
@@ -0,0 +1,24 @@
+#!/usr/bin/env ruby
+
+# This is basically a copy of the original bundler "bundle" shim
+# with the addition of the loading of our Bundler patches that
+# modifies the .lock file naming. Without this, using the original Bundler bundle
+# shim would result in creating or failing on a Gemfile.lock file.
+
+# Exit cleanly from an early interrupt
+Signal.trap("INT") { exit 1 }
+
+$LOAD_PATH.unshift(File.expand_path(File.join("__FILE__", "..", "lib")))
+
+require "logstash/environment"
+Gem.clear_paths
+Gem.paths = ENV['GEM_HOME'] = ENV['GEM_PATH'] = LogStash::Environment.logstash_gem_home
+
+require "bundler"
+require "bundler/cli"
+require "bundler/friendly_errors"
+require "logstash/patches/bundler"
+
+Bundler.with_friendly_errors do
+  Bundler::CLI.start(ARGV, :debug => true)
+end
diff --git a/bin/logstash.lib.sh b/bin/logstash.lib.sh
index 1b1fc46ea15..1da6aa0b817 100755
--- a/bin/logstash.lib.sh
+++ b/bin/logstash.lib.sh
@@ -15,19 +15,34 @@ setup_java() {
   fi
 
   if [ ! -x "$JAVACMD" ] ; then
-    echo "Could not find any executable java binary. Please install java in your PATH or set JAVA_HOME."
+    echo "Could not find any executable java binary. Please install java in your PATH or set JAVA_HOME." 1>&2
     exit 1
   fi
 
-  JAVA_OPTS="$JAVA_OPTS -Xmx${LS_HEAP_SIZE}"
-  JAVA_OPTS="$JAVA_OPTS -XX:+UseParNewGC"
-  JAVA_OPTS="$JAVA_OPTS -XX:+UseConcMarkSweepGC"
-  JAVA_OPTS="$JAVA_OPTS -Djava.awt.headless=true"
+  if [ "$JAVA_OPTS" ] ; then
+    echo "WARNING: Default JAVA_OPTS will be overridden by the JAVA_OPTS defined in the environment. Environment JAVA_OPTS are $JAVA_OPTS"  1>&2
+  else
+    # There are no JAVA_OPTS set from the client, we set a predefined
+    # set of options that think are good in general
+    JAVA_OPTS="-XX:+UseParNewGC"
+    JAVA_OPTS="$JAVA_OPTS -XX:+UseConcMarkSweepGC"
+    JAVA_OPTS="$JAVA_OPTS -Djava.awt.headless=true"
+
+    JAVA_OPTS="$JAVA_OPTS -XX:CMSInitiatingOccupancyFraction=75"
+    JAVA_OPTS="$JAVA_OPTS -XX:+UseCMSInitiatingOccupancyOnly"
+  fi
 
-  JAVA_OPTS="$JAVA_OPTS -XX:CMSInitiatingOccupancyFraction=75"
-  JAVA_OPTS="$JAVA_OPTS -XX:+UseCMSInitiatingOccupancyOnly"
+  if [ "$LS_JAVA_OPTS" ] ; then
+    # The client set the variable LS_JAVA_OPTS, choosing his own
+    # set of java opts.
+    JAVA_OPTS="$JAVA_OPTS $LS_JAVA_OPTS"
+  fi
+
+  if [ "$LS_HEAP_SIZE" ] ; then
+    JAVA_OPTS="$JAVA_OPTS -Xmx${LS_HEAP_SIZE}"
+  fi
 
-  if [ ! -z "$LS_USE_GC_LOGGING" ] ; then
+  if [ "$LS_USE_GC_LOGGING" ] ; then
     JAVA_OPTS="$JAVA_OPTS -XX:+PrintGCDetails"
     JAVA_OPTS="$JAVA_OPTS -XX:+PrintGCTimeStamps"
     JAVA_OPTS="$JAVA_OPTS -XX:+PrintClassHistogram"
@@ -96,7 +111,7 @@ jruby_opts() {
 setup() {
   # first check if we want to use drip, which can be used in vendored jruby mode
   # and also when setting USE_RUBY=1 if the ruby interpretor is in fact jruby
-  if [ ! -z "$JAVACMD" ] ; then
+  if [ "$JAVACMD" ] ; then
     if [ "$(basename $JAVACMD)" = "drip" ] ; then
       DRIP_JAVACMD=1
       USE_DRIP=1
diff --git a/bin/rspec b/bin/rspec
new file mode 100755
index 00000000000..6e825ac62cb
--- /dev/null
+++ b/bin/rspec
@@ -0,0 +1,14 @@
+#!/usr/bin/env ruby
+
+$LOAD_PATH << File.expand_path(File.join("__FILE__", "..", "lib"))
+$LOAD_PATH << File.expand_path(File.join(File.dirname(__FILE__), "../spec"))
+
+require "logstash/environment"
+require "logstash/bundler"
+LogStash::Bundler.setup!
+
+require "rspec/core"
+require "rspec"
+
+status = RSpec::Core::Runner.run(ARGV).to_i
+exit status if status != 0
diff --git a/docs/asciidoc/static/life-of-an-event.asciidoc b/docs/asciidoc/static/life-of-an-event.asciidoc
index 4d25295ecdc..dc7ebdf9c26 100644
--- a/docs/asciidoc/static/life-of-an-event.asciidoc
+++ b/docs/asciidoc/static/life-of-an-event.asciidoc
@@ -13,7 +13,7 @@ You use inputs to get data into Logstash. Some of the more commonly-used inputs
 are:
 
 * *file*: reads from a file on the filesystem, much like the UNIX command
-`tail -0a`
+`tail -0F`
 * *syslog*: listens on the well-known port 514 for syslog messages and parses
 according to the RFC3164 format
 * *redis*: reads from a redis server, using both redis channels and redis lists.
diff --git a/lib/logstash/config/mixin.rb b/lib/logstash/config/mixin.rb
index 60255cf11a4..ed89e570be6 100644
--- a/lib/logstash/config/mixin.rb
+++ b/lib/logstash/config/mixin.rb
@@ -472,7 +472,7 @@ def validate_value(value, validator)
               bytes = Integer(value.first) rescue nil
               result = bytes || Filesize.from(value.first).to_i
             rescue ArgumentError
-              return false, "Unparseable filesize: #{value.first}. possible units (KiB, MiB, ...) e.g. '10 KiB'. doc reference: http://www.elasticsearch.org/guide/en/logstash/current/_logstash_config_language.html#bytes"
+              return false, "Unparseable filesize: #{value.first}. possible units (KiB, MiB, ...) e.g. '10 KiB'. doc reference: http://www.elastic.co/guide/en/logstash/current/configuration.html#bytes"
             end
           else
             return false, "Unknown validator symbol #{validator}"
diff --git a/lib/logstash/event.rb b/lib/logstash/event.rb
index b9b83944f64..2b55fbe1377 100644
--- a/lib/logstash/event.rb
+++ b/lib/logstash/event.rb
@@ -295,11 +295,7 @@ def init_timestamp(o)
 
   public
   def to_hash_with_metadata
-    if @metadata.nil?
-      to_hash
-    else
-      to_hash.merge(METADATA => @metadata)
-    end
+    @metadata.empty? ? to_hash : to_hash.merge(METADATA => @metadata)
   end
 
   public
diff --git a/lib/logstash/java_integration.rb b/lib/logstash/java_integration.rb
index ef9c22a29fb..dded2a320e5 100644
--- a/lib/logstash/java_integration.rb
+++ b/lib/logstash/java_integration.rb
@@ -24,24 +24,39 @@ def self.===(other)
   end
 end
 
+# map_mixin to patch LinkedHashMap and HashMap. it must be done directly on the classes,
+# using a module mixin does not work, and injecting in the Map interface does not work either
+# but injecting in the class works.
 
-# this is a temporary fix to solve a bug in JRuby where classes implementing the Map interface, like LinkedHashMap
-# have a bug in the has_key? method that is implemented in the Enumerable module that is somehow mixed in the Map interface.
-# this bug makes has_key? (and all its aliases) return false for a key that has a nil value.
-# Only LinkedHashMap is patched here because patching the Map interface is not working.
-# TODO find proper fix, and submit upstream
-# releavant JRuby files:
-# https://github.com/jruby/jruby/blob/master/core/src/main/ruby/jruby/java/java_ext/java.util.rb
-# https://github.com/jruby/jruby/blob/master/core/src/main/java/org/jruby/java/proxies/MapJavaProxy.java
-class Java::JavaUtil::LinkedHashMap
+map_mixin = lambda do
+  # this is a temporary fix to solve a bug in JRuby where classes implementing the Map interface, like LinkedHashMap
+  # have a bug in the has_key? method that is implemented in the Enumerable module that is somehow mixed in the Map interface.
+  # this bug makes has_key? (and all its aliases) return false for a key that has a nil value.
+  # Only LinkedHashMap is patched here because patching the Map interface is not working.
+  # TODO find proper fix, and submit upstream
+  # releavant JRuby files:
+  # https://github.com/jruby/jruby/blob/master/core/src/main/ruby/jruby/java/java_ext/java.util.rb
+  # https://github.com/jruby/jruby/blob/master/core/src/main/java/org/jruby/java/proxies/MapJavaProxy.java
   def has_key?(key)
     self.containsKey(key)
   end
   alias_method :include?, :has_key?
   alias_method :member?, :has_key?
   alias_method :key?, :has_key?
+
+  # Java 8 Map implements a merge method with a different signature from
+  # the Ruby Hash#merge. see https://github.com/jruby/jruby/issues/1249
+  # this can be removed when fixed upstream
+  if ENV_JAVA['java.specification.version'] >= '1.8'
+    def merge(other)
+      dup.merge!(other)
+    end
+  end
 end
 
+Java::JavaUtil::LinkedHashMap.module_exec(&map_mixin)
+Java::JavaUtil::HashMap.module_exec(&map_mixin)
+
 module java::util::Map
   # have Map objects like LinkedHashMap objects report is_a?(Array) == true
   def is_a?(clazz)
@@ -77,4 +92,4 @@ def |(other)
     duped.addAll(other)
     duped
   end
-end
\ No newline at end of file
+end
diff --git a/lib/logstash/pluginmanager/command.rb b/lib/logstash/pluginmanager/command.rb
index 2a2c7508c87..692a126ab4b 100644
--- a/lib/logstash/pluginmanager/command.rb
+++ b/lib/logstash/pluginmanager/command.rb
@@ -32,6 +32,7 @@ def remove_unused_locally_installed_gems!
   end
 
   def relative_path(path)
-    Pathname.new(path).relative_path_from(Pathname.new(LogStash::Environment::LOGSTASH_HOME)).to_s
+    require "pathname"
+    ::Pathname.new(path).relative_path_from(::Pathname.new(LogStash::Environment::LOGSTASH_HOME)).to_s
   end
 end
diff --git a/lib/logstash/pluginmanager/uninstall.rb b/lib/logstash/pluginmanager/uninstall.rb
index f881771d8d8..a9a37fed08b 100644
--- a/lib/logstash/pluginmanager/uninstall.rb
+++ b/lib/logstash/pluginmanager/uninstall.rb
@@ -13,7 +13,7 @@ class LogStash::PluginManager::Uninstall < LogStash::PluginManager::Command
   parameter "PLUGIN", "plugin name"
 
   def execute
-    LogStash::Environment.bundler_setup!
+    LogStash::Bundler.setup!
 
     signal_error("File #{LogStash::Environment::GEMFILE_PATH} does not exist or is not writable, aborting") unless File.writable?(LogStash::Environment::GEMFILE_PATH)
 
@@ -31,7 +31,7 @@ def execute
       # any errors will be logged to $stderr by invoke_bundler!
       # output, exception = LogStash::Bundler.invoke_bundler!(:install => true, :clean => true)
       output = LogStash::Bundler.invoke_bundler!(:install => true)
-      
+
       remove_unused_locally_installed_gems!
     end
   rescue => exception
diff --git a/lib/logstash/pluginmanager/update.rb b/lib/logstash/pluginmanager/update.rb
index 70cdbadfc96..396fcb75cb2 100644
--- a/lib/logstash/pluginmanager/update.rb
+++ b/lib/logstash/pluginmanager/update.rb
@@ -14,7 +14,7 @@ class LogStash::PluginManager::Update < LogStash::PluginManager::Command
   def execute
     local_gems = gemfile.locally_installed_gems
 
-    if update_all? || !local_gems.empty?
+    if update_all? && !local_gems.empty?
       error_plugin_that_use_path!(local_gems)
     else
       plugins_with_path = plugins_arg & local_gems
@@ -95,6 +95,7 @@ def display_updated_plugins(previous_gem_specs_map)
   # retrieve only the latest spec for all locally installed plugins
   # @return [Hash] result hash {plugin_name.downcase => plugin_spec}
   def find_latest_gem_specs
+    LogStash::Bundler.setup!
     LogStash::PluginManager.find_plugins_gem_specs.inject({}) do |result, spec|
       previous = result[spec.name.downcase]
       result[spec.name.downcase] = previous ? [previous, spec].max_by{|s| s.version} : spec
diff --git a/lib/logstash/version.rb b/lib/logstash/version.rb
index 36f2bad27fe..695161417bc 100644
--- a/lib/logstash/version.rb
+++ b/lib/logstash/version.rb
@@ -1,6 +1,6 @@
 # encoding: utf-8
 # The version of logstash.
-LOGSTASH_VERSION = "2.0.0.dev"
+LOGSTASH_VERSION = "1.5.0-rc3.snapshot6"
 
 # Note to authors: this should not include dashes because 'gem' barfs if
 # you include a dash in the version string.
diff --git a/logstash-core.gemspec b/logstash-core.gemspec
index 03072b49038..e6a423885e6 100644
--- a/logstash-core.gemspec
+++ b/logstash-core.gemspec
@@ -13,7 +13,7 @@ Gem::Specification.new do |gem|
   gem.test_files    = gem.files.grep(%r{^(test|spec|features)/})
   gem.name          = "logstash-core"
   gem.require_paths = ["lib"]
-  gem.version       = LOGSTASH_VERSION
+  gem.version       = LOGSTASH_VERSION.gsub(/-/, '.')
 
   # Core dependencies
   gem.add_runtime_dependency "cabin", [">=0.7.0"]    #(Apache 2.0 license)
diff --git a/logstash.gemspec b/logstash.gemspec
index 598025b4777..32fd2c61f41 100644
--- a/logstash.gemspec
+++ b/logstash.gemspec
@@ -13,5 +13,5 @@ Gem::Specification.new do |gem|
   gem.test_files    = gem.files.grep(%r{^(test|spec|features)/})
   gem.name          = "logstash"
   gem.require_paths = ["lib"]
-  gem.version       = LOGSTASH_VERSION
+  gem.version       = LOGSTASH_VERSION.gsub(/-/, '.')
 end
diff --git a/pkg/logstash.sysv b/pkg/logstash.sysv
index fddc14d5ed9..ac4ed6d1998 100755
--- a/pkg/logstash.sysv
+++ b/pkg/logstash.sysv
@@ -30,7 +30,6 @@ LS_USER=logstash
 LS_GROUP=logstash
 LS_HOME=/var/lib/logstash
 LS_HEAP_SIZE="500m"
-LS_JAVA_OPTS="-Djava.io.tmpdir=${LS_HOME}"
 LS_LOG_DIR=/var/log/logstash
 LS_LOG_FILE="${LS_LOG_DIR}/$name.log"
 LS_CONF_DIR=/etc/logstash/conf.d
@@ -38,6 +37,7 @@ LS_OPEN_FILES=16384
 LS_NICE=19
 LS_OPTS=""
 
+
 [ -r /etc/default/$name ] && . /etc/default/$name
 [ -r /etc/sysconfig/$name ] && . /etc/sysconfig/$name
 
@@ -46,10 +46,9 @@ args="agent -f ${LS_CONF_DIR} -l ${LS_LOG_FILE} ${LS_OPTS}"
 
 start() {
 
-
-  JAVA_OPTS=${LS_JAVA_OPTS}
+  LS_JAVA_OPTS="${LS_JAVA_OPTS} -Djava.io.tmpdir=${LS_HOME}"
   HOME=${LS_HOME}
-  export PATH HOME JAVA_OPTS LS_HEAP_SIZE LS_JAVA_OPTS LS_USE_GC_LOGGING
+  export PATH HOME LS_HEAP_SIZE LS_JAVA_OPTS LS_USE_GC_LOGGING
 
   # set ulimit as (root, presumably) first, before we drop privileges
   ulimit -n ${LS_OPEN_FILES}
diff --git a/pkg/logstash.sysv.debian b/pkg/logstash.sysv.debian
index 61e8c809933..5795cdb991e 100644
--- a/pkg/logstash.sysv.debian
+++ b/pkg/logstash.sysv.debian
@@ -37,7 +37,6 @@ LS_USER=logstash
 LS_GROUP=logstash
 LS_HOME=/var/lib/logstash
 LS_HEAP_SIZE="500m"
-LS_JAVA_OPTS="-Djava.io.tmpdir=${LS_HOME}"
 LS_LOG_FILE=/var/log/logstash/$NAME.log
 LS_CONF_DIR=/etc/logstash/conf.d
 LS_OPEN_FILES=16384
@@ -85,10 +84,10 @@ case "$1" in
       >/dev/null; then
          # Prepare environment
          HOME="${HOME:-$LS_HOME}"
-         JAVA_OPTS="${LS_JAVA_OPTS}"
+         LS_JAVA_OPTS="${LS_JAVA_OPTS} -Djava.io.tmpdir=${LS_HOME}"
          ulimit -n ${LS_OPEN_FILES}
 	 cd "${LS_HOME}"
-         export PATH HOME JAVACMD JAVA_OPTS LS_HEAP_SIZE LS_JAVA_OPTS LS_USE_GC_LOGGING
+         export PATH HOME JAVACMD LS_HEAP_SIZE LS_JAVA_OPTS LS_USE_GC_LOGGING
 
          # Start Daemon
          start-stop-daemon --start -b --user "$LS_USER" -c "$LS_USER":"$LS_GROUP" \
diff --git a/pkg/logstash.sysv.redhat b/pkg/logstash.sysv.redhat
index f95f3c1db34..c228e355e9b 100755
--- a/pkg/logstash.sysv.redhat
+++ b/pkg/logstash.sysv.redhat
@@ -36,7 +36,6 @@ LS_USER=logstash
 LS_GROUP=logstash
 LS_HOME=/var/lib/logstash
 LS_HEAP_SIZE="500m"
-LS_JAVA_OPTS="-Djava.io.tmpdir=${LS_HOME}"
 LS_LOG_FILE=/var/log/logstash/$NAME.log
 LS_CONF_DIR=/etc/logstash/conf.d
 LS_OPEN_FILES=16384
@@ -73,10 +72,10 @@ do_start()
 
   # Prepare environment
   HOME="${HOME:-$LS_HOME}"
-  JAVA_OPTS="${LS_JAVA_OPTS}"
+  LS_JAVA_OPTS="${LS_JAVA_OPTS} -Djava.io.tmpdir=${LS_HOME}"
   ulimit -n ${LS_OPEN_FILES}
   cd "${LS_HOME}"
-  export PATH HOME JAVA_OPTS LS_HEAP_SIZE LS_JAVA_OPTS LS_USE_GC_LOGGING
+  export PATH HOME LS_HEAP_SIZE LS_JAVA_OPTS LS_USE_GC_LOGGING
   test -n "${JAVACMD}" && export JAVACMD
 
   nice -n ${LS_NICE} runuser -s /bin/sh -c "exec $DAEMON $DAEMON_OPTS" ${LS_USER} >> $LS_LOG_FILE 2>&1 < /dev/null &
diff --git a/pkg/logstash.upstart.ubuntu b/pkg/logstash.upstart.ubuntu
index 54994f70226..68730ffe949 100644
--- a/pkg/logstash.upstart.ubuntu
+++ b/pkg/logstash.upstart.ubuntu
@@ -23,7 +23,6 @@ script
   PATH=/bin:/usr/bin
   LS_HOME=/var/lib/logstash
   LS_HEAP_SIZE="500m"
-  LS_JAVA_OPTS="-Djava.io.tmpdir=${LS_HOME}"
   LS_LOG_FILE=/var/log/logstash/logstash.log
   LS_USE_GC_LOGGING=""
   LS_CONF_DIR=/etc/logstash/conf.d
@@ -35,13 +34,13 @@ script
   [ -f /etc/default/logstash ] && . /etc/default/logstash
 
   HOME="${HOME:-$LS_HOME}"
-  JAVA_OPTS="${LS_JAVA_OPTS}"
+  LS_JAVA_OPTS="${LS_JAVA_OPTS} -Djava.io.tmpdir=${LS_HOME}"
   # Reset filehandle limit
   ulimit -n ${LS_OPEN_FILES}
   cd "${LS_HOME}"
 
   # Export variables
-  export PATH HOME JAVA_OPTS LS_HEAP_SIZE LS_JAVA_OPTS LS_USE_GC_LOGGING
+  export PATH HOME LS_HEAP_SIZE LS_JAVA_OPTS LS_USE_GC_LOGGING
   test -n "${JAVACMD}" && export JAVACMD
 
   exec nice -n ${LS_NICE} /opt/logstash/bin/logstash agent -f "${LS_CONF_DIR}" -l "${LS_LOG_FILE}" ${LS_OPTS}
diff --git a/rakelib/artifacts.rake b/rakelib/artifacts.rake
index 39201740d79..35ce8863c60 100644
--- a/rakelib/artifacts.rake
+++ b/rakelib/artifacts.rake
@@ -2,30 +2,29 @@ namespace "artifact" do
 
   def package_files
     [
-      ".bundle/config",
       "LICENSE",
       "CHANGELOG",
       "CONTRIBUTORS",
       "{bin,lib,spec,locales}/{,**/*}",
       "patterns/**/*",
       "vendor/??*/**/*",
-      "Gemfile*",
-      "logstash-core.gemspec",
+      "Gemfile",
+      "Gemfile.jruby-1.9.lock",
     ]
   end
 
   def exclude_paths
     return @exclude_paths if @exclude_paths
+
     @exclude_paths = []
-    #gitignore = File.join(File.dirname(__FILE__), "..", ".gitignore")
-    #if File.exists?(gitignore)
-      #@exclude_paths += File.read(gitignore).split("\n")
-    #end
     @exclude_paths << "spec/reports/**/*"
     @exclude_paths << "**/*.gem"
     @exclude_paths << "**/test/files/slow-xpath.xml"
     @exclude_paths << "**/logstash-*/spec"
-    return @exclude_paths
+    @exclude_paths << "bin/bundle"
+    @exclude_paths << "bin/rspec"
+
+    @exclude_paths
   end
 
   def excludes
@@ -49,11 +48,6 @@ namespace "artifact" do
     FileUtils.cp("Gemfile.jruby-1.9.lock.defaults", "Gemfile.jruby-1.9.lock")
   end
 
-  task "freeze-defaults-gemfile" => ["bootstrap", "plugin:install-default"] do
-    FileUtils.cp("Gemfile", "Gemfile.defaults")
-    FileUtils.cp("Gemfile.jruby-1.9.lock", "Gemfile.jruby-1.9.lock.defaults")
-  end
-
   # We create an empty bundle config file
   # This will allow the deb and rpm to create a file
   # with the correct user group and permission.
diff --git a/rakelib/vendor.rake b/rakelib/vendor.rake
index 36303185fa5..ad671d5745f 100644
--- a/rakelib/vendor.rake
+++ b/rakelib/vendor.rake
@@ -1,6 +1,6 @@
 namespace "vendor" do
   VERSIONS = {
-    "jruby" => { "version" => "1.7.17", "sha1" => "e4621bbcc51242061eaa9b62caee69c2a2b433f0" },
+    "jruby" => { "version" => "1.7.19", "sha1" => "a3296d1ae9b9aa78825b8d65a0d2498b449eaa3d" },
   }
 
   def vendor(*args)
diff --git a/spec/core/event_spec.rb b/spec/core/event_spec.rb
index 4182e0402ff..8cc98499291 100644
--- a/spec/core/event_spec.rb
+++ b/spec/core/event_spec.rb
@@ -409,16 +409,20 @@
         it "should still allow normal field access" do
           expect(subject["foo"]).to eq("bar")
         end
+
+        it "should not include the @metadata key" do
+          expect(subject.to_hash_with_metadata).not_to include("@metadata")
+        end
       end
     end
+  end
 
-    context "signal events" do
-      it "should define the shutdown event" do
-        # the SHUTDOWN and FLUSH constants are part of the plugin API contract
-        # if they are changed, all plugins must be updated
-        expect(LogStash::SHUTDOWN).to be_a(LogStash::ShutdownEvent)
-        expect(LogStash::FLUSH).to be_a(LogStash::FlushEvent)
-      end
+  context "signal events" do
+    it "should define the shutdown event" do
+      # the SHUTDOWN and FLUSH constants are part of the plugin API contract
+      # if they are changed, all plugins must be updated
+      expect(LogStash::SHUTDOWN).to be_a(LogStash::ShutdownEvent)
+      expect(LogStash::FLUSH).to be_a(LogStash::FlushEvent)
     end
   end
 
diff --git a/spec/lib/logstash/java_integration_spec.rb b/spec/lib/logstash/java_integration_spec.rb
index 19c4f0d75dd..0d4219a8e4c 100644
--- a/spec/lib/logstash/java_integration_spec.rb
+++ b/spec/lib/logstash/java_integration_spec.rb
@@ -50,6 +50,35 @@
     end
   end
 
+  context "Java::JavaUtil::Map" do
+    # this is to test the Java 8 Map interface change for the merge method
+
+    let(:merger){{:a => 1, :b => 2}}
+    let(:mergee){{:b => 3, :c => 4}}
+
+    shared_examples "map merge" do
+      it "should support merging" do
+        expect(subject.merge(mergee)).to eq({:a => 1, :b => 3, :c => 4})
+      end
+
+      it "should return a new hash and not change original hash" do
+        expect{subject.merge(mergee)}.to_not change{subject}
+      end
+    end
+
+    context "with Java::JavaUtil::LinkedHashMap" do
+      it_behaves_like "map merge" do
+        subject{Java::JavaUtil::LinkedHashMap.new(merger)}
+      end
+    end
+
+    context "with Java::JavaUtil::HashMap" do
+      it_behaves_like "map merge" do
+        subject{Java::JavaUtil::HashMap.new(merger)}
+      end
+    end
+  end
+
   context "Java::JavaUtil::Collection" do
     subject{Java::JavaUtil::ArrayList.new(initial_array)}
 
